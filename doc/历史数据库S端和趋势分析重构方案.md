# 历史数据库S端和趋势分析重构方案-刘世全

## 1. 技术栈

| 关注项       | 说明                                                         | 相关链接                                                     |
| ------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
| 框架         | .NET 8+                                                      | https://dotnet.microsoft.com/zh-cn/download/dotnet/9.0       |
| 程序模板     | Avalonia UI                                                  | https://avaloniaui.net/                                      |
| 控件库       | [Semi.Avalonia](https://github.com/irihitech/Semi.Avalonia)、[Ursa.Avalonia](https://github.com/irihitech/Ursa.Avalonia) | MIT协议                                                      |
| 图表库       | 自绘，调研 [ScottPlot](https://github.com/ScottPlot/ScottPlot) 和 [LiveCharts2](https://github.com/beto-rodriguez/LiveCharts2) ，不满足点一段时间没有数据、超限标识功能 |                                                              |
| 操作系统支持 | 支持Win 7 SP1、Windows 8.1+、Linux（统信UOS、银河麒麟等）、macOS | https://docs.avaloniaui.net/docs/faq#what-versions-of-windows-are-supported |
| IDE          | VS2022\|Rider                                                |                                                              |

## 2. 工时评估

总工时：276h=34.5d

| 模块\|功能        | 工时（h) | 备注                                                         |
| ----------------- | -------- | ------------------------------------------------------------ |
| 调研              | 32       | 数据存储方式（SQLite，多线程读写，上百G数据支持），折线图调研（目前考虑自绘） |
| 开发环境准备      | 16       | 目前远程有VS2022安装包，但Avalonia UI扩展安装需要联网，需要解决；可考虑使用Rider开发，有证书，考虑破解版，或淘宝几元买license |
| 历史数据库S端重构 | 68       | 界面保持原有风格，搭建框架，包括同步时间配置、快照、加载快照、网络配置等 |
| 趋势分析C端       | 160      | C端功能比较复杂                                              |

## 3. 历史数据库S端

### 情况

| 关键项   | 旧                                 | 新                                                           |
| -------- | ---------------------------------- | ------------------------------------------------------------ |
| 框架     | .NET 4.5.2 + Winform + Dev Express | .NET 8+、Avalonia UI、Semi.Avalonia、Ursa.Avalonia           |
| 操作系统 | Win 7+                             | 支持Win 7 SP1、Windows 8.1+、Linux（统信UOS、银河麒麟等）、macOS |
|          |                                    |                                                              |

### 功能

总：68h

| 功能               | 说明                       | 备注                                    |
| ------------------ | -------------------------- | --------------------------------------- |
| 框架搭建           |                            | 8h，日志展示、本地记录                  |
| 存储配置           |                            | 8h，实时数据库消息服务连接、UDP组播订阅 |
| 收集测点           | 从实时数据库S端TCP读取     | 8h，读取、界面选择                      |
| 实时数据库UDP订阅  | 从实时数据库S端UDP组播订阅 | 4h                                      |
| 开启历史数据库服务 | 服务接口重构               | 16h                                     |
| 数据存取           | Sqlite                     | 24h                                     |

## 4. 趋势分析C端

### 情况

| 关键项   | 旧                   | 新                                                           |
| -------- | -------------------- | ------------------------------------------------------------ |
| 框架     | Qt 5.12.10           | .NET 8+、Avalonia UI、Semi.Avalonia、Ursa.Avalonia           |
| 操作系统 | Win 7+、Linux、macOS | 支持Win 7 SP1、Windows 8.1+、Linux（统信UOS、银河麒麟等）、macOS |

### 功能

总工时：160h

| 功能         | 说明                    | 备注                                                         |
| ------------ | ----------------------- | ------------------------------------------------------------ |
| 框架搭建     | 支持单独进程            | 16h，实时数据库S端和历史数据库S端地址由实时数据库C端配置、传入 |
| 实时曲线     | 从实时数据库UDP组播订阅 | 24h，曲线展示（支持4分窗口），表格展示                       |
| 历史曲线     | 从历史数据库TCP查询     | 32h，曲线展示，表格展示，控制（延长、压缩、前一、前半、重置、后半、后一） |
| 分组管理     | 保存、另存为、打开      | 16h                                                          |
| 打印         | 趋势图打印              | 4h                                                           |
| 曲线设置     | 网格显隐、表格显隐      | 4h                                                           |
| 分组信息编辑 |                         | 24h                                                          |
| 趋势点组编辑 |                         | 24h                                                          |
| 数值预览窗口 | 表格显示历史值          | 16                                                           |

## 5. 问题

1. 实时数据接收状态不一

**问：**目前UDP分两种数据包传递，一是传实时值，二是传告警状态和更新时间，两个数据包很难合成一条数据。

**解决方案：**实时值与状态包添加一个包批次字段，简单确认两种数据包批次

## 6. 数据库设计

### 6.1. 设计一

存2种数据库：

- 一是固定存点基本信息；
- 二是存点实时数据，根据日期灵活创建数据库；

#### 1. BaseInfo.db

点基本信息库，只存储基本信息表[Point]，程序不能直接删除：

| 字段名 | 数据类型           |          |
| ------ | ------------------ | -------- |
| Id     | int                |          |
| Name   | varchar(50)        | 名称     |
| Type   | 0:Integer,1:Double | 数据类型 |

#### 2. Data_[XXXX].db

点值数据库，分库库名为Data_[当天日期],示例：【Data_20240624.db】

| 字段名     | 数据类型 |                                                   |
| ---------- | -------- | ------------------------------------------------- |
| Id         | int      |                                                   |
| PointId    | int      | 点Id，对应Point表Id字段                           |
| Value      | double   | 点值                                              |
| Status     | TINYINT  | 告警状态                                          |
| UpdateTime | int      | 采集时间，只存当天时间戳（0点到采集时间的毫秒数） |

**空间占用分析**：20万数据，500ms推送间隔

一条数据大小：4+4+8+1+4=21字节

一天：21 * 200000 * 2 * 60 * 60 * 24=675G

实际DB文件测试：10分钟3.58G，一天3.58 * 6 * 24 = 515.52G

### 6.2. 设计二

#### 2024-06-24/point1.db

参考原历史数据库设计，每天创建一个目录，目录名以收集时间`yyyy-MM-dd.db`命名，每个点再生成一个库，库名以点名命名，表[PointValue]定义如下：

| 字段名     | 数据类型 |                                                   |
| ---------- | -------- | ------------------------------------------------- |
| Id         | int      |                                                   |
| Value      | double   | 点值                                              |
| Status     | TINYINT  | 告警状态                                          |
| UpdateTime | int      | 采集时间，只存当天时间戳（0点到采集时间的毫秒数） |

**空间占用分析**：20万数据，500ms推送间隔

一条数据大小：4+8+1+4=17字节

一天：17 * 200000 * 2 * 60 * 60 * 24=547G

实际DB文件测试：
